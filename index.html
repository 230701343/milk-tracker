<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Personal Milk Expense Tracker</title>

<!-- CDN libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg1:#6d28d9; --bg2:#3b82f6;
    --card: rgba(255,255,255,0.96);
    --muted:#475569; --accent:#8b5cf6;
  }

  /* Global + background */
  html, body {
    height: 100%;
    min-height: 100vh;
    margin: 0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: #07203a;
    /* smooth violet -> blue gradient, fixed */
    background: linear-gradient(135deg, var(--bg1) 0%, #7b3be8 40%, var(--bg2) 100%);
    background-attachment: fixed;
    background-repeat: no-repeat;
    overflow-x: hidden;
  }

  /* Container centered and constrained */
  .container {
    max-width: 1100px;
    margin: 18px auto;
    padding: 12px;
    box-sizing: border-box;
    background: transparent;
  }

  /* Topbar: always centered (title + subtitle + nav) */
  .topbar {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
    text-align: center;
    padding-top: 6px;
    padding-bottom: 6px;
  }
  .topbar > div {
    width: 100%;
    max-width: 1100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    padding-left: 8px;
    padding-right: 8px;
    box-sizing: border-box;
  }

  .title {
    color: white;
    font-weight: 800;
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    line-height: 1;
  }
  .subtitle {
    color: rgba(255,255,255,0.95);
    font-size: 13px;
    margin-top: 4px;
    max-width: 900px;
  }

  /* Nav centered under title */
  .nav {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    margin: 0;
  }
  .nav button {
    background: rgba(255,255,255,0.14);
    border: 0;
    color: white;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
  }
  .nav button.active {
    background: white;
    color: var(--bg1);
    box-shadow: 0 6px 18px rgba(2,6,23,0.12);
  }

  /* Layout (centered) */
  .layout {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
    box-sizing: border-box;
  }
  /* constrain columns */
  #mainContent, .right {
    width: 100%;
    max-width: 760px;
    box-sizing: border-box;
  }
  @media (min-width: 1000px) {
    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
      align-items: start;
      justify-items: center;
    }
    #mainContent { max-width: 760px; width:100%; }
    .right { max-width: 360px; width:100%; }
  }

  /* Cards & controls */
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 8px 24px rgba(2,6,23,0.14);
    box-sizing: border-box;
    width: 100%;
    overflow: hidden;
  }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
  .search { padding:8px 10px; border-radius:8px; border:1px solid #e6e9ee; min-width:160px; box-sizing:border-box; }
  .btn { padding:8px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:700; background:white; box-shadow:0 6px 16px rgba(15,23,42,0.06); }
  .btn-primary { background: linear-gradient(90deg, var(--accent), #60a5fa); color:white; }
  .filter-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
  .small { font-size:13px; color: var(--muted); }

  /* Month controls + calendar */
  .month-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:8px; flex-wrap:wrap; width:100%; box-sizing:border-box; }
  .month-controls { display:flex; gap:8px; align-items:center; }
  .month-title { font-size:18px; font-weight:800; margin:0; }

  /* Calendar grid - compact sequential days (no leading/trailing blanks) */
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
  }
  .day{
    background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.92));
    border-radius:12px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    transition: transform .16s, box-shadow .16s;
    cursor: pointer;
    min-height: 90px;
    box-sizing: border-box;
  }
  .day:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(5,12,30,0.12); }
  .date-num { font-weight:800; font-size:16px; display:flex; justify-content:space-between; align-items:center; }
  .entry-line { font-size:13px; display:flex; justify-content:space-between; gap:6px; }
  .placeholder { color: var(--muted); font-size:13px; padding-top:8px; }
  .total-badge { margin-top:auto; background: linear-gradient(90deg,var(--accent),#60a5fa); color:white; padding:6px 8px; border-radius:10px; font-weight:700; font-size:13px; text-align:center; transform-origin:center; transition:transform .35s; }
  .bloom { animation: bloom .55s cubic-bezier(.2,.9,.3,1); }
  @keyframes bloom { 0%{transform:scale(.9);opacity:.6}40%{transform:scale(1.08);opacity:1}100%{transform:scale(1)} }

  /* Right panel */
  .right { display:flex; flex-direction:column; gap:12px; }
  .big-total { font-size:28px; font-weight:800; margin:6px 0; }
  .compare { font-size:14px; color: var(--muted); }

  /* Modal */
  .modal-backdrop {
    position: fixed; inset: 0; display: none;
    align-items: center; justify-content: center;
    z-index: 60;
    background: linear-gradient(rgba(2,6,23,0.45), rgba(2,6,23,0.45));
    padding: 16px;
    box-sizing: border-box;
    overflow: auto;
  }
  .modal {
    width: 100%;
    max-width: 520px;
    background: white;
    border-radius: 12px;
    padding: 18px;
    box-sizing: border-box;
    max-height: calc(100vh - 40px);
    overflow: auto;
  }
  .form-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap; }
  .form-row label { min-width:110px; font-size:14px; color:var(--muted); }
  input[type="number"], input[type="text"], input[type="date"], select { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ee; font-size:16px; max-width:100%; box-sizing:border-box; }
  .modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }

  /* Confetti canvas */
  #confettiCanvas { position: fixed; left:0; top:0; pointer-events:none; width:100%; height:100%; z-index:80; }

  /* Responsive grid breakpoints (columns adapt by device width) */
  @media (min-width: 1100px) {
    .calendar { grid-template-columns: repeat(7, 1fr); }
  }
  @media (max-width:1099px) and (min-width:700px) {
    .calendar { grid-template-columns: repeat(4, 1fr); }
  }
  @media (max-width:699px) and (min-width:480px) {
    .calendar { grid-template-columns: repeat(3, 1fr); gap:10px; }
  }
  @media (max-width:479px) {
    .calendar { grid-template-columns: repeat(2, 1fr); gap:10px; }
    .day { min-height: 110px; padding: 10px; border-radius:12px; }
    .date-num { font-size:15px; }
    .entry-line { font-size:13px; }
    .total-badge { font-size:13px; padding:6px; }
  }

  /* Controls & header small-screen polish */
  @media (max-width:980px){
    .layout { display:block; }
    .right { order: 2; }
    .calendar { grid-template-columns: repeat(3,1fr); }
    .title { font-size:18px; }
  }

  @media (max-width:520px) {
    .topbar { padding-left:10px; padding-right:10px; }
    .nav { width:100%; justify-content:center; margin-top:6px; }
    .subtitle { font-size:13px; }

    .month-bar { flex-direction: row; align-items:center; justify-content:space-between; width:100%; }
    .controls .month-bar, .filter-row { flex-direction: column; gap:8px; align-items:flex-start; width:100%; }
    .search { min-width:0; width:100%; }
    .filter-row input[type="date"] { width:100%; }
    .btn { padding:8px 10px; }

    .container { padding-left:8px; padding-right:8px; }
  }

  /* Prevent horizontal scroll & ensure consistent card backgrounds */
  html, body { overflow-x: hidden; }
  .card { background: rgba(255,255,255,0.98); }

  /* Small visual tweaks */
  .title + .subtitle, .subtitle { color: rgba(255,255,255,0.95); text-shadow: 0 1px 0 rgba(0,0,0,.12); }
</style>


</head>
<body>
<div class="container">
  <div class="topbar">
    <div>
      <div class="title">ðŸ¥› Personal Milk Expense Tracker</div>
      <div class="subtitle small">Track morning & night milk, export reports, and view monthly insights</div>
    </div>

    <div class="nav" role="tablist" aria-label="Main navigation">
      <button id="tabCalendar" class="active" role="tab">Calendar</button>
      <button id="tabAnalysis" role="tab">Analysis</button>
    </div>
  </div>

  <div class="layout">
    <div id="mainContent">
      <div class="card">
        <div class="controls">
          <div class="month-bar" style="flex:1;display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div class="month-controls">
              <button class="btn" id="prevMonth">â—€</button>
              <div class="month-title" id="monthTitle">Month</div>
              <button class="btn" id="nextMonth">â–¶</button>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <input id="searchDate" class="search" placeholder="DD-MM-YYYY or DD-MM" />
              <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="largeTextToggle" /> <span class="small">Large text</span></label>
            </div>
          </div>
        </div>

        <div class="filter-row">
          <label class="small">From<input type="date" id="filterFrom" style="margin-left:6px" /></label>
          <label class="small">To<input type="date" id="filterTo" style="margin-left:6px" /></label>
          <button class="btn" id="applyRange">Apply</button>
          <button class="btn" id="clearRange">Clear</button>
          <div style="margin-left:auto" class="small" id="todayHelper">Today: <span id="todayHelperDate"></span></div>
        </div>

        <div id="calendarRoot" class="calendar" role="grid" aria-label="Milk purchase calendar"></div>
      </div>
    </div>

    <aside class="right">
      <div id="summaryCard" class="card">
        <h3 style="margin:0 0 8px 0">Monthly Summary</h3>
        <div class="big-total" id="monthTotal">â‚¹0</div>
        <div class="compare" id="compareText">Last month: â‚¹0 â€¢ Change: 0%</div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">
            <div class="small">Total litres</div>
            <div id="totalLitres" style="font-weight:700">0 L</div>
          </div>
          <div style="flex:1">
            <div class="small">Avg / day</div>
            <div id="avgPerDay" style="font-weight:700">â‚¹0</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small">Most expensive day: <span id="mostExp">â€”</span></div>
          <div class="small">Least expensive day: <span id="leastExp">â€”</span></div>
        </div>

        <div style="height:220px;margin-top:10px;">
          <canvas id="monthChart" width="400" height="220" aria-label="Daily totals chart"></canvas>
        </div>

        <div class="actions" style="margin-top:8px">
          <button class="btn" id="exportCSV">Export CSV</button>
          <button class="btn" id="exportPDF">Export PDF</button>
          <button class="btn btn-primary" id="syncBtn">Sync (Sheet)</button>
        </div>

        <p class="small" style="margin-top:8px" id="sentenceSummary"></p>
      </div>

      <div id="analysisCard" class="card analysis-card" style="display:none">
        <h3 style="margin:0 0 8px 0">Analysis</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <select id="yearSelect" style="padding:8px;border-radius:8px;border:1px solid #e6e9ee"></select>
          <div class="small">Click a month bar to jump to that month</div>
        </div>
        <div style="height:240px">
          <canvas id="yearChart" width="400" height="240"></canvas>
        </div>
      </div>
    </aside>
  </div>
</div>

<canvas id="confettiCanvas"></canvas>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="modalDate">Date</h2>
    <div class="form-row">
      <label for="pricePerLitre">Price / L (â‚¹)</label>
      <input id="pricePerLitre" type="number" step="0.01" min="0" value="48" />
    </div>
    <div class="form-row">
      <label for="morningLitres">â˜€ Morning (L)</label>
      <input id="morningLitres" type="number" step="0.25" min="0" />
      <div id="morningAmount" class="small" style="min-width:110px;text-align:right;">â‚¹0</div>
    </div>
    <div class="form-row">
      <label for="nightLitres">ðŸŒ™ Night (L)</label>
      <input id="nightLitres" type="number" step="0.25" min="0" />
      <div id="nightAmount" class="small" style="min-width:110px;text-align:right;">â‚¹0</div>
    </div>

    <div class="form-row">
      <label>Notes</label>
      <input id="noteField" type="text" placeholder="e.g., extra for guests" />
    </div>

    <div class="form-row">
      <label>Total</label>
      <div id="modalTotal" style="font-weight:800;">â‚¹0</div>
    </div>

    <div class="modal-footer">
      <button class="btn" id="clearBtn">Clear</button>
      <button class="btn" id="cancelBtn">Cancel</button>
      <button class="btn btn-primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SHEETDB_API = "https://sheetdb.io/api/v1/pm3r23ogtfgrj"; // <-- your SheetDB API (leave empty if not using)
const STORAGE_KEY = "milk_tracker_entries_compact_v1";
const DEFAULT_PRICE = 48;

/* ---------- UTIL ---------- */
function formatCurrency(num){
  const n = Number(num) || 0;
  return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits:2 }).format(Math.round(n*100)/100);
}
function pad(n){ return n<10? '0'+n : ''+n; }

/* ---------- DATA ---------- */
let entries = {}; // key: YYYY-MM-DD
let viewDate = new Date(); // current month view
let monthChart = null, yearChart = null;

/* ---------- STORAGE ---------- */
function loadFromLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); entries = raw ? JSON.parse(raw) : {}; }catch(e){ entries={}; } }
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

/* ---------- SHEETDB UPsert ---------- */
async function syncToSheetUpsert(){
  if(!SHEETDB_API){ alert("SHEETDB_API not configured."); return; }
  const all = Object.values(entries);
  try{
    for(const e of all){
      const updateRes = await fetch(`${SHEETDB_API}/date/${e.date}`, {
        method: 'PUT',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ data: [ {
          date: e.date,
          morning_litre: e.morningLitres,
          night_litre: e.nightLitres,
          price_per_litre: e.pricePerLitre,
          morning_amount: e.morningAmount,
          night_amount: e.nightAmount,
          total: e.total,
          notes: e.notes || ''
        } ] })
      });
      if(updateRes.status === 404 || !updateRes.ok){
        await fetch(SHEETDB_API, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify([{
            date: e.date,
            morning_litre: e.morningLitres,
            night_litre: e.nightLitres,
            price_per_litre: e.pricePerLitre,
            morning_amount: e.morningAmount,
            night_amount: e.nightAmount,
            total: e.total,
            notes: e.notes || ''
          }])
        });
      }
    }
    alert("Sync completed (upsert).");
  }catch(err){ console.error(err); alert("Sync error: " + err.message); }
}

/* ---------- RENDER CALENDAR (compact sequential days) ---------- */
const calendarRoot = document.getElementById('calendarRoot');
const monthTitle = document.getElementById('monthTitle');
const monthTotalEl = document.getElementById('monthTotal');
const compareText = document.getElementById('compareText');
const totalLitresEl = document.getElementById('totalLitres');
const avgPerDayEl = document.getElementById('avgPerDay');
const mostExpEl = document.getElementById('mostExp');
const leastExpEl = document.getElementById('leastExp');
const sentenceSummaryEl = document.getElementById('sentenceSummary');
const todayHelperDate = document.getElementById('todayHelperDate');

function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function ddmmyyyy(iso){
  const p = iso.split('-'); if(p.length!==3) return iso;
  return `${pad(Number(p[2]))}-${pad(Number(p[1]))}-${p[0]}`;
}

/* Important change: we render only the days of the month in sequential order.
   No leading/trailing placeholders. The grid simply wraps every 7 items. */
function renderCalendar(){
  calendarRoot.innerHTML = '';
  const start = startOfMonth(viewDate), end = endOfMonth(viewDate);
  const daysCount = end.getDate();

  // create day tiles from 1..daysCount (no blanks)
  for(let d=1; d<=daysCount; d++){
    const dateObj = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
    calendarRoot.appendChild(dayTile(d, dateObj));
  }

  monthTitle.textContent = viewDate.toLocaleString('default',{month:'long', year:'numeric'});
  // today helper
  const t = new Date();
  todayHelperDate.textContent = `${pad(t.getDate())}-${pad(t.getMonth()+1)}-${t.getFullYear()}`;
  updateSummaryAndChart();
}

function dayTile(dayNum, dateObj){
  const wrapper = document.createElement('div');
  wrapper.className = 'day';
  wrapper.setAttribute('role','gridcell');
  const y=dateObj.getFullYear(), m=pad(dateObj.getMonth()+1), d=pad(dateObj.getDate());
  const key = `${y}-${m}-${d}`;

  const dateNum = document.createElement('div'); dateNum.className='date-num';
  dateNum.innerHTML = `<span>${pad(dateObj.getDate())}-${pad(dateObj.getMonth()+1)}</span><span style="font-size:12px;color:var(--muted)">${dateObj.toLocaleString('default',{weekday:'short'})}</span>`;
  wrapper.appendChild(dateNum);

  const entry = entries[key];
  if(entry && (entry.morningLitres || entry.nightLitres || entry.total)){
    const morningLine = document.createElement('div'); morningLine.className='entry-line';
    morningLine.innerHTML = `<span>â˜€ ${entry.morningLitres ?? 0} L</span><span>${formatCurrency(entry.morningAmount ?? 0)}</span>`;
    const nightLine = document.createElement('div'); nightLine.className='entry-line';
    nightLine.innerHTML = `<span>ðŸŒ™ ${entry.nightLitres ?? 0} L</span><span>${formatCurrency(entry.nightAmount ?? 0)}</span>`;
    wrapper.appendChild(morningLine); wrapper.appendChild(nightLine);
    const totalBadge = document.createElement('div'); totalBadge.className='total-badge';
    totalBadge.textContent = `ðŸ¥› ${formatCurrency(entry.total ?? 0)}`;
    wrapper.appendChild(totalBadge);
    if(entry.notes){ const noteEl = document.createElement('div'); noteEl.className='small'; noteEl.textContent = 'ðŸ“ ' + entry.notes; wrapper.appendChild(noteEl); }
  } else {
    const ph = document.createElement('div'); ph.className='placeholder'; ph.textContent='Tap to add ðŸ¥›';
    wrapper.appendChild(ph);
  }

  wrapper.addEventListener('click', ()=> openModalForDate(key));
  return wrapper;
}

/* ---------- MODAL ---------- */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalDateEl = document.getElementById('modalDate');
const priceInput = document.getElementById('pricePerLitre');
const morningInput = document.getElementById('morningLitres');
const nightInput = document.getElementById('nightLitres');
const noteField = document.getElementById('noteField');
const morningAmountEl = document.getElementById('morningAmount');
const nightAmountEl = document.getElementById('nightAmount');
const modalTotalEl = document.getElementById('modalTotal');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const clearBtn = document.getElementById('clearBtn');

let currentModalDate = null;

function openModalForDate(dateKey){
  currentModalDate = dateKey;
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden','false');
  modalDateEl.textContent = ddmmyyyy(dateKey) + ' â€” ' + new Date(dateKey).toLocaleString('en-GB',{weekday:'long'});
  const e = entries[dateKey] || {};
  priceInput.value = e.pricePerLitre ?? DEFAULT_PRICE;
  morningInput.value = e.morningLitres ?? '';
  nightInput.value = e.nightLitres ?? '';
  noteField.value = e.notes ?? '';
  updateModalAmounts();
  morningInput.focus();
}
function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); currentModalDate=null; }

function parseNum(v){ const n = Number(v); return isNaN(n)?0:n; }
function updateModalAmounts(){
  const p = parseNum(priceInput.value);
  const mL = parseNum(morningInput.value);
  const nL = parseNum(nightInput.value);
  const mAmt = Math.round(mL * p * 100) / 100;
  const nAmt = Math.round(nL * p * 100) / 100;
  morningAmountEl.textContent = formatCurrency(mAmt);
  nightAmountEl.textContent = formatCurrency(nAmt);
  modalTotalEl.textContent = formatCurrency(Math.round((mAmt + nAmt) * 100) / 100);
}

saveBtn.addEventListener('click', ()=>{
  if(!currentModalDate) return;
  const p = parseNum(priceInput.value);
  const mL = parseNum(morningInput.value);
  const nL = parseNum(nightInput.value);
  const mAmt = Math.round(mL * p * 100) / 100;
  const nAmt = Math.round(nL * p * 100) / 100;
  const total = Math.round((mAmt + nAmt) * 100) / 100;
  const entry = { date: currentModalDate, morningLitres: mL, nightLitres: nL, pricePerLitre: p, morningAmount: mAmt, nightAmount: nAmt, total, notes: noteField.value || '' };
  entries[currentModalDate] = entry;
  saveLocal();
  renderCalendar();
  triggerBloomForDate(currentModalDate);
  closeModal();
});
cancelBtn.addEventListener('click', closeModal);
clearBtn.addEventListener('click', ()=>{
  if(!currentModalDate) return;
  if(entries[currentModalDate]) delete entries[currentModalDate];
  saveLocal();
  renderCalendar();
  closeModal();
});
priceInput.addEventListener('input', updateModalAmounts);
morningInput.addEventListener('input', updateModalAmounts);
nightInput.addEventListener('input', updateModalAmounts);

/* ---------- SUMMARY & CHART ---------- */
const monthChartCtx = document.getElementById('monthChart').getContext('2d');

function updateSummaryAndChart(rangeFrom=null, rangeTo=null){
  const y = viewDate.getFullYear(), m = viewDate.getMonth();
  const daysCount = new Date(y, m+1, 0).getDate();
  const labels = [], data = [];
  let monthTotal = 0, monthLitres = 0;
  const dailyMap = {};
  for(let d=1; d<=daysCount; d++){
    const key = `${y}-${pad(m+1)}-${pad(d)}`;
    const e = entries[key] || {};
    const val = Number(e.total || 0);
    labels.push('' + d);
    data.push(val);
    monthTotal += val;
    monthLitres += (Number(e.morningLitres||0) + Number(e.nightLitres||0));
    if(val > 0) dailyMap[key] = val;
  }
  monthTotal = Math.round(monthTotal*100)/100;
  monthTotalEl.textContent = formatCurrency(monthTotal);
  totalLitresEl.textContent = `${Math.round(monthLitres*100)/100} L`;
  const avg = daysCount === 0 ? 0 : Math.round((monthTotal / daysCount) * 100) / 100;
  avgPerDayEl.textContent = formatCurrency(avg);

  const entriesKeys = Object.keys(dailyMap);
  if(entriesKeys.length === 0){
    mostExpEl.textContent = 'â€”';
    leastExpEl.textContent = 'â€”';
  } else {
    const sorted = entriesKeys.sort((a,b)=> dailyMap[b] - dailyMap[a]);
    mostExpEl.textContent = `${ddmmyyyy(sorted[0])} (${formatCurrency(dailyMap[sorted[0]])})`;
    leastExpEl.textContent = `${ddmmyyyy(sorted[sorted.length-1])} (${formatCurrency(dailyMap[sorted[sorted.length-1]])})`;
  }

  sentenceSummaryEl.textContent = `This month you bought ${Math.round(monthLitres*100)/100} L milk and spent ${formatCurrency(monthTotal)}. Average ${formatCurrency(avg)}/day.`;

  // compare last month
  const last = new Date(y, m-1, 1); const ly=last.getFullYear(), lm=last.getMonth();
  let lastTotal=0;
  for(let d=1; d<= new Date(ly, lm+1, 0).getDate(); d++){
    const key = `${ly}-${pad(lm+1)}-${pad(d)}`; lastTotal += Number((entries[key] && entries[key].total) || 0);
  }
  lastTotal = Math.round(lastTotal*100)/100;
  const diff = monthTotal - lastTotal;
  const pct = lastTotal === 0 ? (monthTotal === 0 ? 0 : 100) : Math.round((diff/lastTotal)*100);
  compareText.textContent = `Last month: ${formatCurrency(lastTotal)} â€¢ This month: ${formatCurrency(monthTotal)} â€¢ Change: ${pct >=0 ? '+' : ''}${pct}%`;

  // chart (full month dataset)
  if(monthChart) monthChart.destroy();
  monthChart = new Chart(monthChartCtx, {
    type: 'bar',
    data: { labels, datasets:[{ label:'Daily total', data, borderRadius:6, barThickness:18 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback:(v)=> formatCurrency(v) } } }, plugins:{ legend:{ display:false } } }
  });

  checkMissingToday();
}

/* ---------- MISSING TODAY ---------- */
function checkMissingToday(){
  const t = new Date(); const key = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
  const e = entries[key];
  const helperEl = document.getElementById('todayHelperDate');
  if(!e || ((!e.morningLitres && !e.nightLitres) || (Number(e.morningLitres)===0 && Number(e.nightLitres)===0))){
    helperEl.textContent = `${pad(t.getDate())}-${pad(t.getMonth()+1)}-${t.getFullYear()} â€” No entry today`;
    helperEl.style.color = '#f59e0b';
  } else { helperEl.textContent = `${pad(t.getDate())}-${pad(t.getMonth()+1)}-${t.getFullYear()} â€” Entry present`; helperEl.style.color = ''; }
}

/* ---------- SEARCH ---------- */
document.getElementById('searchDate').addEventListener('keydown', (ev)=>{
  if(ev.key === 'Enter'){
    const q = ev.target.value.trim();
    if(!q) return;
    let targetIso = null;
    if(/^\d{2}-\d{2}-\d{4}$/.test(q)){
      const parts = q.split('-'); targetIso = `${parts[2]}-${parts[1]}-${parts[0]}`;
    } else if(/^\d{1,2}-\d{1,2}$/.test(q)){
      const parts = q.split('-'); const d = pad(Number(parts[0])); const m = pad(Number(parts[1])); const y = viewDate.getFullYear();
      targetIso = `${y}-${m}-${d}`;
    } else {
      alert('Use DD-MM-YYYY or DD-MM (e.g., 11-11).');
      return;
    }
    const [yy,mm,dd] = targetIso.split('-'); viewDate = new Date(Number(yy), Number(mm)-1, 1);
    renderCalendar();
    setTimeout(()=> openModalForDate(targetIso), 250);
  }
});

/* ---------- RANGE FILTER ---------- */
document.getElementById('applyRange').addEventListener('click', ()=>{
  const f = document.getElementById('filterFrom').value;
  const t = document.getElementById('filterTo').value;
  if(!f || !t){ alert('Select both From and To'); return; }
  updateSummaryAndChart(f, t);
});
document.getElementById('clearRange').addEventListener('click', ()=> { document.getElementById('filterFrom').value=''; document.getElementById('filterTo').value=''; updateSummaryAndChart(); });

/* ---------- EXPORT & SYNC ---------- */
document.getElementById('exportCSV').addEventListener('click', ()=>{
  const y=viewDate.getFullYear(), m=viewDate.getMonth()+1; const days=new Date(y,m,0).getDate(); const rows=[];
  for(let d=1; d<=days; d++){ const key=`${y}-${pad(m)}-${pad(d)}`; const e = entries[key]||{}; rows.push({ date:key, morning_litres:e.morningLitres||0, morning_amount:e.morningAmount||0, night_litres:e.nightLitres||0, night_amount:e.nightAmount||0, total:e.total||0, notes:e.notes||'' }); }
  const csv = Papa.unparse(rows); const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`milk_${y}_${pad(m)}.csv`; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('exportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
  const y=viewDate.getFullYear(), m=viewDate.getMonth()+1; const days=new Date(y,m,0).getDate(); const rows=[]; let total=0;
  for(let d=1; d<=days; d++){ const key=`${y}-${pad(m)}-${pad(d)}`; const e=entries[key]||{}; rows.push([key,e.morningLitres||0,e.morningAmount||0,e.nightLitres||0,e.nightAmount||0,e.total||0,e.notes||'']); total+=Number(e.total||0); }
  doc.setFontSize(14); doc.text(`Milk Expenses - ${viewDate.toLocaleString('default',{month:'long',year:'numeric'})}`,40,40);
  doc.autoTable({ head:[['Date','M (L)','M â‚¹','N (L)','N â‚¹','Total â‚¹','Notes']], body:rows, startY:70, styles:{fontSize:10} });
  doc.text(`Month total: ${formatCurrency(total)}`,40,doc.lastAutoTable.finalY+20); doc.save(`milk_${y}_${pad(m)}.pdf`);
});
document.getElementById('syncBtn').addEventListener('click', syncToSheetUpsert);

/* ---------- NAV & ANALYSIS ---------- */
const tabCalendar = document.getElementById('tabCalendar');
const tabAnalysis = document.getElementById('tabAnalysis');
const summaryCard = document.getElementById('summaryCard');
const analysisCard = document.getElementById('analysisCard');

tabCalendar.addEventListener('click', ()=> showTab('calendar'));
tabAnalysis.addEventListener('click', ()=> showTab('analysis'));

function showTab(name){
  if(name === 'analysis'){
    tabAnalysis.classList.add('active'); tabCalendar.classList.remove('active');
    summaryCard.style.display = 'none'; analysisCard.style.display = 'block';
    buildYearOptions(); updateYearChart();
  } else {
    tabCalendar.classList.add('active'); tabAnalysis.classList.remove('active');
    summaryCard.style.display = 'block'; analysisCard.style.display = 'none';
  }
}

/* ---------- BLOOM + CONFETTI ---------- */
const confettiCanvas = document.getElementById('confettiCanvas');
confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });

function triggerBloomForDate(dateKey){
  const tiles = Array.from(document.querySelectorAll('.day'));
  tiles.forEach(tile=>{
    if(tile.querySelector('.date-num') && tile.querySelector('.date-num').textContent.includes(dateKey.split('-')[2])){
      const badge = tile.querySelector('.total-badge'); if(badge){ badge.classList.remove('bloom'); void badge.offsetWidth; badge.classList.add('bloom'); }
    }
  });
  runConfettiBurst();
}
function runConfettiBurst(){
  const ctx = confettiCanvas.getContext('2d'); const pieces=[]; const W=confettiCanvas.width, H=confettiCanvas.height;
  for(let i=0;i<70;i++) pieces.push({ x:Math.random()*W, y:-20-Math.random()*200, vx:(Math.random()-0.5)*6, vy:2+Math.random()*6, size:6+Math.random()*8, color:['#ef4444','#f59e0b','#10b981','#60a5fa','#8b5cf6'][Math.floor(Math.random()*5)], rot:Math.random()*360 });
  let t=0; function frame(){ t++; ctx.clearRect(0,0,W,H); pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore(); }); if(t<120) requestAnimationFrame(frame); else ctx.clearRect(0,0,W,H); } frame();
}

/* ---------- ANALYSIS (Yearly chart) ---------- */
const yearSelect = document.getElementById('yearSelect');
const yearChartCtx = document.getElementById('yearChart')?.getContext?.('2d');

function buildYearOptions(){
  const years = new Set([new Date().getFullYear()]);
  Object.keys(entries).forEach(k=>{ const y = Number(k.split('-')[0]); if(!isNaN(y)) years.add(y); });
  const sorted = Array.from(years).sort((a,b)=>b-a);
  yearSelect.innerHTML=''; sorted.forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o); });
}
function updateYearChart(){
  if(!yearChartCtx) return;
  const year = Number(yearSelect.value) || new Date().getFullYear();
  const monthTotals = new Array(12).fill(0);
  Object.keys(entries).forEach(k=>{ const [yy,mm]=k.split('-').map(Number); if(yy===year) monthTotals[mm-1]+=Number(entries[k].total||0); });
  if(yearChart) yearChart.destroy();
  yearChart = new Chart(yearChartCtx, {
    type:'bar',
    data:{ labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets:[{ label:'Month total', data:monthTotals, backgroundColor:monthTotals.map(v=>v>0?'#60a5fa':'rgba(200,200,200,0.3)'), borderRadius:8 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, onClick:(evt,items)=>{ if(items.length>0){ const idx = items[0].index; viewDate = new Date(year, idx, 1); showTab('calendar'); renderCalendar(); } } }
  });
}
yearSelect.addEventListener('change', updateYearChart);

/* ---------- NAV CONTROLS ---------- */
document.getElementById('prevMonth').addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderCalendar(); });
document.getElementById('nextMonth').addEventListener('click', ()=>{ viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderCalendar(); });
document.getElementById('largeTextToggle').addEventListener('change', (e)=>{ if(e.target.checked) document.body.classList.add('large'); else document.body.classList.remove('large'); });

/* ---------- SEARCH placeholder ignored above (already done) ---------- */

/* ---------- INITIALIZE ---------- */
loadFromLocal();
renderCalendar();
showTab('calendar');

/* close modal on backdrop/escape */
modalBackdrop.addEventListener('click',(e)=>{ if(e.target===modalBackdrop) closeModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

</script>
</body>
</html>
